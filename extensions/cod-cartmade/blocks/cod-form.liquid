{{ 'https://cdn.tailwindcss.com' | script_tag }}

{% assign productId = product.id %}
{% assign variantId = product.variants[0].id %}

<button id="openModal" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none">
  COD Cartmade
</button>

<div id="modal" class=" inset-0 bg-black bg-opacity-50  justify-center items-center hidden">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-semibold mb-4">Fill out the form</h2>
    <form id="myForm">
      <input type="hidden" name="productId" value="{{ productId }}">
      <input type="hidden" name="variantId" value="{{ variantId }}">
      <input type="hidden" name="shop" value="{{ shop.name }}">
      <input type="hidden" name="quantity" value="{{product.quantity}}">

      <div class="mb-4">
        <div class="flex items-center justify-between">
          <label class="block text-gray-700">Contact No:</label>
          <button id="verifyContactNo" type="button"
            class="bg-blue-500 hover:bg-blue-600 rounded-md py-2 px-4 text-white font-semibold transition-colors">
            Verify
          </button>
        </div>
        <input type="number" id="contactNo" name="contactNo"
          class="mt-2 block w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          required>
      </div>

      <div id="otpSection" class="mb-4 hidden">
        <label class="block text-gray-700">Enter OTP:</label>
        <input type="text" id="otpCode" name="otpCode"
          class="mt-2 block w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <button id="verifyOtp" type="button"
          class="bg-green-500 hover:bg-green-600 rounded-md py-2 px-4 text-white mt-2">
          Verify OTP
        </button>
      </div>

      <div class="mb-4">
        <label class="block text-gray-700">First Name</label>
        <input type="text" name="firstName" class="mt-1 block w-full p-2 border border-gray-300 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Last Name</label>
        <input type="text" name="lastName" class="mt-1 block w-full p-2 border border-gray-300 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Email Address</label>
        <input type="email" name="email" class="mt-1 block w-full p-2 border border-gray-300 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Address Line 1</label>
        <input type="text" name="address1" class="mt-1 block w-full p-2 border border-gray-300 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Address Line 2</label>
        <input type="text" name="address2" class="mt-1 block w-full p-2 border border-gray-300 rounded">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Province</label>
        <input type="text" name="province" class="mt-1 block w-full p-2 border border-gray-300 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">City</label>
        <input type="text" name="city" class="mt-1 block w-full p-2 border border-gray-300 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Zip Code</label>
        <input type="text" name="zipcode" class="mt-1 block w-full p-2 border border-gray-300 rounded" required>
      </div>

      <div class="flex justify-end">
        <button type="button" id="closeModal"
          class="mr-2 px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 focus:outline-none">
          Close
        </button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 focus:outline-none">
          Submit
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const openModalBtn = document.getElementById('openModal');
  const closeModalBtn = document.getElementById('closeModal');
  const modal = document.getElementById('modal');
  const form = document.getElementById('myForm');
  const otpSection = document.getElementById('otpSection');
  let quantity = parseInt(document.querySelector('.quantity__input').value);

  const url = "https://gazette-generations-partial-theory.trycloudflare.com"

  openModalBtn.addEventListener('click', () => {
    modal.classList.toggle("hidden")
  });

  closeModalBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  const verifyContactNoBtn = document.getElementById('verifyContactNo');
  const verifyOtpBtn = document.getElementById('verifyOtp');

  // Verify Contact Number
  verifyContactNoBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    const contactNo = document.querySelector('input[name="contactNo"]').value;

    if (!contactNo) {
      alert("Please enter a contact number to verify.");
      return;
    }

    try {
      const response = await fetch(`${url}/api/number_verification`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contactNo })
      });
      const result = await response.json();

      if (result.statusCode === 200) {
        alert('Contact number verified successfully. Enter the OTP.');
        otpSection.classList.remove('hidden');
      } else {
        alert('Verification failed. Please try again.');
      }
    } catch (error) {
      console.error('Error during verification:', error);
      alert('An error occurred. Please try again later OTP.');
    }
  });

  // Verify OTP
  verifyOtpBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    const otpCode = document.querySelector('input[name="otpCode"]').value;
    const contactNo = document.querySelector('input[name="contactNo"]').value;

    if (!otpCode || !contactNo) {
      alert("Please enter the OTP.");
      return;
    }

    try {
      const response = await fetch(`${url}/api/number_verification`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contactNo, otpCode })
      });
      const result = await response.json();
      console.log(result)
      if (result.success) {
        alert('OTP verified successfully.');
        otpSection.classList.add('hidden');
      } else {
        alert('OTP verification failed.');
      }
    } catch (error) {
      console.error('Error during OTP verification:', error);
      alert('An error occurred. Please try again later.');
    }
  });

  // Submit form and log the form data
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    formData.append("quantity", Number(quantity));
    const data = {};
    formData.forEach((value, key) => {
      data[key] = value;
    });

    try {
      const response = await fetch(`${url}/api/create_order`, {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "Content-Type": "application/json",
        },
      });
      const actualResponse = await response.json();
      console.log(actualResponse, "data");
      if (actualResponse.statusCode !== 200) {
        alert("Something went wrong");
      }
      alert("Your order has been placed.");
      modal.classList.add('hidden');
      form.reset();
    } catch (error) {
      console.log(error);
    }
  });
</script>

{% schema %}
{
"name": "COD-FORM",
"target": "section",
"settings": [
{ "type": "product", "id": "product", "label": "Product", "autofill": true },
{ "type": "color", "id": "colour", "label": "Star Colour", "default": "#ff0000" }
]
}
{% endschema %}